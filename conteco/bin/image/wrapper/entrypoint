#!/usr/bin/env bash
export CONTECO_IMAGE="$CONTECO_TYPE.$CONTECO_NAME"
export CONTECO_EXECUTIONPLANE_BASEPATH=$PATH

export PATH="/conteco/bin:/conteco/bin/image:/conteco/bin/image/executionplane:${CONTECO_EXECUTIONPLANE_BASEPATH}"
export CONTECO_EXECUTIONPLANE_ORIGINALPATH=$PATH

export PATH="/conteco/bin/image/wrapper:${CONTECO_EXECUTIONPLANE_ORIGINALPATH}"
export CONTECO_EXECUTIONPLANE_WRAPPERPATH=$PATH

if [[ $CONTECO_PREENTRYPOINT != "" ]] ; then
  . "$CONTECO_PREENTRYPOINT"
fi

export CONTECO_EXECUTIONPLANE_APIEXTERNALPATH="/conteco/bin/${CONTECO_TYPE}/${CONTECO_NAME}:${CONTECO_EXECUTIONPLANE_ORIGINALPATH}"
export CONTECO_EXECUTIONPLANE_APIINTERNALPATH="/conteco/bin/${CONTECO_TYPE}/${CONTECO_NAME}:/conteco/bin/${CONTECO_TYPE}/${CONTECO_NAME}/internal:/conteco/bin/${CONTECO_TYPE}/internal:$CONTECO_EXECUTIONPLANE_ORIGINALPATH"

export CONTECO_EXECUTIONPLANE="${CONTECO_IMAGE}"

if [[ $1 == '--executiontag' ]] ; then
  export CONTECO_EXECUTIONTAG=$2
  shift
  shift
fi

match='--'
# --base forces entrypoint invocation with arguments - always JSON output
if [[ $1 == '--base' ]] ; then
  ( run-image $@ ) > >( to-JSON "INFO" ) 2> >( to-JSON "ERROR" )

# --interactive forces text output, required when interactively running processes within a container
elif [[ $1 == '--interactive' ]] ; then
  shift
  run-image $@

# --container switch forces JSON output
elif [[ $1 == '--container' ]] ; then
  shift
  ( run-image $@ ) > >( to-JSON "INFO" ) 2> >( to-JSON "ERROR" )

# double hyphen switches target image wrapper API, unless --base is used first
# default mode is interactive and default output is text 
elif [[ $1 == $match* ]] ; then
  run-image $@

# default mode is JSON output
else
  ( run-image $@ ) > >( to-JSON "INFO" ) 2> >( to-JSON "ERROR" )
fi
